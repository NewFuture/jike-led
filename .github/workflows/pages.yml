name: Deploy to GitHub Pages

on:
  # Trigger when a release is published
  release:
    types: [published]
  # Allow manual trigger
  workflow_dispatch:
  # Also trigger when release workflow completes
  workflow_run:
    workflows: ["Auto Release Patched Firmware"]
    types:
      - completed

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch latest release data
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch the latest release information
          RELEASE_JSON=$(gh api repos/${{ github.repository }}/releases/latest 2>&1) || {
            echo "::warning::Failed to fetch release data: $RELEASE_JSON"
            RELEASE_JSON='{}'
          }
          
          if [ "$RELEASE_JSON" = "{}" ] || [ "$(echo "$RELEASE_JSON" | jq -r '.message // empty')" = "Not Found" ]; then
            echo "No releases found, creating placeholder page"
            echo "has_release=false" >> $GITHUB_OUTPUT
          else
            echo "has_release=true" >> $GITHUB_OUTPUT
            
            # Extract release information
            TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
            RELEASE_NAME=$(echo "$RELEASE_JSON" | jq -r '.name')
            RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body')
            PUBLISHED_AT=$(echo "$RELEASE_JSON" | jq -r '.published_at')
            HTML_URL=$(echo "$RELEASE_JSON" | jq -r '.html_url')
            
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
            echo "html_url=$HTML_URL" >> $GITHUB_OUTPUT
            echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT
            
            # Save release body to file for later use
            echo "$RELEASE_BODY" > /tmp/release_body.md
            
            # Get assets list
            echo "$RELEASE_JSON" | jq -r '.assets[] | "\(.name)|\(.browser_download_url)|\(.size)"' > /tmp/assets.txt
            
            echo "Release: $RELEASE_NAME ($TAG_NAME)"
            echo "Assets count: $(wc -l < /tmp/assets.txt)"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build site
        env:
          HAS_RELEASE: ${{ steps.release.outputs.has_release }}
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          RELEASE_NAME: ${{ steps.release.outputs.release_name }}
          HTML_URL: ${{ steps.release.outputs.html_url }}
          PUBLISHED_AT: ${{ steps.release.outputs.published_at }}
        run: |
          mkdir -p _site
          
          # Copy CNAME file if exists
          if [ -f CNAME ]; then
            cp CNAME _site/
          fi
          
          # Generate index.html
          cat > _site/index.html << 'HTMLHEADER'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>é›†å®¢ LED å›ºä»¶ä¿®å¤å·¥å…· - Jike LED Firmware Patcher</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-light.min.css">
            <style>
              body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
                background-color: #f6f8fa;
              }
              .markdown-body {
                background-color: white;
                padding: 45px;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
              }
              .header {
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 1px solid #e1e4e8;
              }
              .header h1 {
                margin: 0 0 10px 0;
                color: #24292e;
              }
              .header .subtitle {
                color: #586069;
                font-size: 1.1em;
              }
              .release-info {
                background-color: #f1f8ff;
                border: 1px solid #c8e1ff;
                border-radius: 6px;
                padding: 15px;
                margin-bottom: 20px;
              }
              .release-info .version {
                font-size: 1.5em;
                font-weight: bold;
                color: #0366d6;
              }
              .release-info .date {
                color: #586069;
                font-size: 0.9em;
              }
              .github-link {
                display: inline-block;
                background-color: #24292e;
                color: white !important;
                padding: 10px 20px;
                border-radius: 6px;
                text-decoration: none;
                margin-top: 10px;
              }
              .github-link:hover {
                background-color: #2f363d;
              }
              .no-release {
                text-align: center;
                padding: 40px;
                color: #586069;
              }
              @media (max-width: 767px) {
                body {
                  padding: 15px;
                }
                .markdown-body {
                  padding: 20px;
                }
              }
              table {
                width: 100%;
                border-collapse: collapse;
              }
              th, td {
                padding: 8px 12px;
                text-align: left;
                border: 1px solid #e1e4e8;
              }
              th {
                background-color: #f6f8fa;
              }
              a {
                color: #0366d6;
              }
              .footer {
                text-align: center;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #e1e4e8;
                color: #586069;
                font-size: 0.9em;
              }
              .footer a {
                color: #0366d6;
              }
            </style>
          </head>
          <body>
            <article class="markdown-body">
              <div class="header">
                <h1>ğŸ”§ é›†å®¢ LED å›ºä»¶ä¿®å¤å·¥å…·</h1>
                <p class="subtitle">Jike Gecoos AP LED Firmware Patcher</p>
              </div>
          HTMLHEADER
          
          if [ "$HAS_RELEASE" = "true" ]; then
            # Format date with fallback
            if [ -n "$PUBLISHED_AT" ]; then
              FORMATTED_DATE=$(date -d "${PUBLISHED_AT}" "+%Y-%m-%d %H:%M UTC" 2>/dev/null || echo "${PUBLISHED_AT%T*}")
            else
              FORMATTED_DATE="æœªçŸ¥"
            fi
            
            # Add release info
            cat >> _site/index.html << RELEASEINFO
              <div class="release-info">
                <span class="version">ğŸ“¦ æœ€æ–°ç‰ˆæœ¬: ${RELEASE_NAME}</span>
                <span class="date"> | å‘å¸ƒæ—¶é—´: ${FORMATTED_DATE}</span>
                <br>
                <a href="${HTML_URL}" class="github-link" target="_blank">ğŸ”— å‰å¾€ GitHub Releases ä¸‹è½½</a>
              </div>
          RELEASEINFO
            
            # Convert release notes from Markdown to HTML
            if [ -f /tmp/release_body.md ]; then
              # pandoc is pre-installed on ubuntu-latest runner
              # Fall back to apt-get install if not available
              if ! command -v pandoc &> /dev/null; then
                echo "Installing pandoc..."
                sudo apt-get update -qq && sudo apt-get install -y -qq pandoc > /dev/null 2>&1
              fi
              
              # Convert markdown to HTML
              pandoc /tmp/release_body.md -f gfm -t html -o /tmp/release_body.html
              
              # Append release notes
              cat /tmp/release_body.html >> _site/index.html
            fi
          else
            # No release yet
            cat >> _site/index.html << 'NORELEASE'
              <div class="no-release">
                <h2>æš‚æ— å‘å¸ƒç‰ˆæœ¬</h2>
                <p>ç›®å‰è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•å›ºä»¶ç‰ˆæœ¬ã€‚</p>
                <p>è¯·è®¿é—® <a href="https://github.com/NewFuture/jike-led">GitHub ä»“åº“</a> è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
              </div>
          NORELEASE
          fi
          
          # Add footer
          cat >> _site/index.html << 'HTMLFOOTER'
              <div class="footer">
                <p>
                  <a href="https://github.com/NewFuture/jike-led">ğŸ“‚ GitHub ä»“åº“</a> |
                  <a href="https://github.com/NewFuture/jike-led/issues">ğŸ› é—®é¢˜åé¦ˆ</a> |
                  <a href="https://github.com/NewFuture/jike-led#readme">ğŸ“– ä½¿ç”¨è¯´æ˜</a>
                </p>
                <p>Â© 2024-2025 NewFuture. Licensed under Apache 2.0</p>
              </div>
            </article>
          </body>
          </html>
          HTMLFOOTER
          
          echo "Site built successfully"
          ls -la _site/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
