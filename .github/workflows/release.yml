name: Auto Release Patched Firmware

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
  schedule:
    # Run daily at 2 AM UTC to check for new firmware
    - cron: '0 2 * * *'

# Sets permissions for the GITHUB_TOKEN
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "release-and-pages"
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Download and parse firmware list
      id: download
      run: |
        echo "Downloading firmware list page..."
        curl -s "http://file.cnrouter.com/index.php/Index/apbeta.html" > firmware_list.html
        
        # Extract firmware URLs and filenames for AP250MDV and AP250MD
        echo "Extracting firmware URLs..."
        
        # Find AP250MDV firmware
        AP250MDV_URL=$(grep -oP 'href="/upload/test/[^"]*JIKEAP_AP250MDV_MT7981_K5_NAND_[^"]*\.bin"' firmware_list.html | sed 's/href="//' | sed 's/"$//' | head -1)
        if [ -n "$AP250MDV_URL" ]; then
          AP250MDV_FILENAME=$(echo "$AP250MDV_URL" | grep -oP 'JIKEAP_AP250MDV_MT7981_K5_NAND_[^/]*\.bin$')
          AP250MDV_FULL_URL="http://file.cnrouter.com${AP250MDV_URL}"
          echo "ap250mdv_url=$AP250MDV_FULL_URL" >> $GITHUB_OUTPUT
          echo "ap250mdv_filename=$AP250MDV_FILENAME" >> $GITHUB_OUTPUT
          echo "Found AP250MDV: $AP250MDV_FILENAME"
          echo "URL: $AP250MDV_FULL_URL"
        fi
        
        # Find AP250MD firmware (without V)
        AP250MD_URL=$(grep -oP 'href="/upload/test/[^"]*JIKEAP_AP250MD_MT7981_K5_NAND_[^"]*\.bin"' firmware_list.html | grep -v "AP250MDV" | sed 's/href="//' | sed 's/"$//' | head -1)
        if [ -n "$AP250MD_URL" ]; then
          AP250MD_FILENAME=$(echo "$AP250MD_URL" | grep -oP 'JIKEAP_AP250MD_MT7981_K5_NAND_[^/]*\.bin$')
          AP250MD_FULL_URL="http://file.cnrouter.com${AP250MD_URL}"
          echo "ap250md_url=$AP250MD_FULL_URL" >> $GITHUB_OUTPUT
          echo "ap250md_filename=$AP250MD_FILENAME" >> $GITHUB_OUTPUT
          echo "Found AP250MD: $AP250MD_FILENAME"
          echo "URL: $AP250MD_FULL_URL"
        fi
        
        # Check if we found any firmware
        if [ -z "$AP250MDV_URL" ] && [ -z "$AP250MD_URL" ]; then
          echo "Error: No firmware files found!"
          exit 1
        fi
        
        # Extract version/date for release tag
        if [ -n "$AP250MDV_FILENAME" ]; then
          VERSION=$(echo "$AP250MDV_FILENAME" | grep -oP '\d+\.\d+_\d{10}' | head -1)
        elif [ -n "$AP250MD_FILENAME" ]; then
          VERSION=$(echo "$AP250MD_FILENAME" | grep -oP '\d+\.\d+_\d{10}' | head -1)
        fi
        if [ -z "$VERSION" ]; then
          echo "Error: Failed to extract firmware version from filename. Aborting release."
          exit 1
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
    
    - name: Check if release already exists
      run: |
        if gh release view "v${{ steps.download.outputs.version }}" > /dev/null 2>&1; then
          echo "Release v${{ steps.download.outputs.version }} already exists. Skipping workflow."
          exit 0
        fi
    
    - name: Download AP250MDV firmware
      if: steps.download.outputs.ap250mdv_url != ''
      run: |
        echo "Downloading AP250MDV firmware..."
        curl -L -o "${{ steps.download.outputs.ap250mdv_filename }}" "${{ steps.download.outputs.ap250mdv_url }}" || exit 1
        if [ ! -f "${{ steps.download.outputs.ap250mdv_filename }}" ]; then
          echo "Error: Failed to download AP250MDV firmware file"
          exit 1
        fi
        ls -lh "${{ steps.download.outputs.ap250mdv_filename }}"
    
    - name: Download AP250MD firmware
      if: steps.download.outputs.ap250md_url != ''
      run: |
        echo "Downloading AP250MD firmware..."
        curl -L -o "${{ steps.download.outputs.ap250md_filename }}" "${{ steps.download.outputs.ap250md_url }}" || exit 1
        if [ ! -f "${{ steps.download.outputs.ap250md_filename }}" ]; then
          echo "Error: Failed to download AP250MD firmware file"
          exit 1
        fi
        ls -lh "${{ steps.download.outputs.ap250md_filename }}"
    
    - name: Patch AP250MDV firmware for all boards
      if: steps.download.outputs.ap250mdv_filename != ''
      run: |
        echo "Patching AP250MDV firmware for all configured boards..."
        python3 fix_led.py "${{ steps.download.outputs.ap250mdv_filename }}"
        echo ""
        echo "Generated patched files:"
        ls -lh *"${{ steps.download.outputs.ap250mdv_filename }}" 2>/dev/null || echo "No patched files generated"
    
    - name: Patch AP250MD firmware for all boards
      if: steps.download.outputs.ap250md_filename != ''
      run: |
        echo "Patching AP250MD firmware for all configured boards..."
        python3 fix_led.py "${{ steps.download.outputs.ap250md_filename }}"
        echo ""
        echo "Generated patched files:"
        ls -lh *"${{ steps.download.outputs.ap250md_filename }}" 2>/dev/null || echo "No patched files generated"
    
    - name: Prepare release files
      id: prepare
      run: |
        echo "Preparing release files..."
        mkdir -p release-files
        
        # Move all patched firmware files to release directory
        # Patched files have format: <board>-JIKEAP_AP250MD*.bin
        # Note: The pattern "*-JIKEAP_AP250MD*.bin" intentionally matches both AP250MD and AP250MDV firmware files,
        # since "AP250MDV" contains "AP250MD". This ensures both variants are included in the release.
        find . -maxdepth 1 -type f -name "*-JIKEAP_AP250MD*.bin" -exec mv {} release-files/ \;
        
        # Also move original firmware files to release directory
        # Original files have format: JIKEAP_AP250MD*.bin (without board prefix)
        if [ -n "${{ steps.download.outputs.ap250mdv_filename }}" ] && [ -f "${{ steps.download.outputs.ap250mdv_filename }}" ]; then
          mv "${{ steps.download.outputs.ap250mdv_filename }}" release-files/
          echo "Added original firmware: ${{ steps.download.outputs.ap250mdv_filename }}"
        fi
        if [ -n "${{ steps.download.outputs.ap250md_filename }}" ] && [ -f "${{ steps.download.outputs.ap250md_filename }}" ]; then
          mv "${{ steps.download.outputs.ap250md_filename }}" release-files/
          echo "Added original firmware: ${{ steps.download.outputs.ap250md_filename }}"
        fi
        
        echo "Files prepared for release:"
        ls -lh release-files/
        
        # Count files
        FILE_COUNT=$(ls -1 release-files/*.bin 2>/dev/null | wc -l)
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "Total files: $FILE_COUNT"
    
    - name: Create Release
      id: create_release
      if: steps.prepare.outputs.file_count > 0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Set release tag and name
        if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
          TAG_NAME="${GITHUB_REF_NAME}"
          RELEASE_NAME="${GITHUB_REF_NAME}"
        else
          TAG_NAME="v${{ steps.download.outputs.version }}"
          RELEASE_NAME="${{ steps.download.outputs.version }}"
        fi
        
        echo "Creating release: $TAG_NAME"
        
        # Get repository info for download links
        REPO_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}"
        
        # Read the release notes template
        cp .github/release-notes-template.md release_notes.md
        
        # Generate original firmware list to a temp file
        > /tmp/original_firmware.txt
        if [ -n "${{ steps.download.outputs.ap250mdv_filename }}" ]; then
          echo "- [${{ steps.download.outputs.ap250mdv_filename }}](${REPO_URL}/${{ steps.download.outputs.ap250mdv_filename }})" >> /tmp/original_firmware.txt
        fi
        if [ -n "${{ steps.download.outputs.ap250md_filename }}" ]; then
          echo "- [${{ steps.download.outputs.ap250md_filename }}](${REPO_URL}/${{ steps.download.outputs.ap250md_filename }})" >> /tmp/original_firmware.txt
        fi
        
        # Generate board table rows to a temp file
        > /tmp/board_table.txt
        grep '^\[' leds.ini | sed 's/\[\([^];]*\)\].*/\1/' | while read -r board; do
          AP250MDV_FILE="${board}-${{ steps.download.outputs.ap250mdv_filename }}"
          AP250MD_FILE="${board}-${{ steps.download.outputs.ap250md_filename }}"
          
          # Build table row with download links
          ROW="| ${board} |"
          
          if [ -n "${{ steps.download.outputs.ap250mdv_filename }}" ] && [ -f "release-files/${AP250MDV_FILE}" ]; then
            ROW="${ROW} [ä¸‹è½½](${REPO_URL}/${AP250MDV_FILE}) |"
          else
            ROW="${ROW} - |"
          fi
          
          if [ -n "${{ steps.download.outputs.ap250md_filename }}" ] && [ -f "release-files/${AP250MD_FILE}" ]; then
            ROW="${ROW} [ä¸‹è½½](${REPO_URL}/${AP250MD_FILE}) |"
          else
            ROW="${ROW} - |"
          fi
          
          echo "${ROW}" >> /tmp/board_table.txt
        done
        
        # Replace placeholders in template using sed with file content
        # First, escape special characters in the replacement text (& / \ and the delimiter #)
        ORIGINAL_FIRMWARE=$(cat /tmp/original_firmware.txt | sed 's#[&#/\\]#\\&#g' | tr '\n' '\r')
        BOARD_TABLE=$(cat /tmp/board_table.txt | sed 's#[&#/\\]#\\&#g' | tr '\n' '\r')
        
        # Replace placeholders (using \r as newline placeholder)
        sed -i "s#{{ORIGINAL_FIRMWARE}}#${ORIGINAL_FIRMWARE}#g" release_notes.md
        sed -i "s#{{BOARD_TABLE}}#${BOARD_TABLE}#g" release_notes.md
        
        # Convert \r back to newlines
        sed -i 's/\r/\n/g' release_notes.md
        
        # Create or update release
        if gh release view "$TAG_NAME" >/dev/null 2>&1; then
          echo "Release $TAG_NAME already exists, updating..."
          gh release edit "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes-file release_notes.md
          gh release upload "$TAG_NAME" release-files/*.bin --clobber
        else
          echo "Creating new release $TAG_NAME..."
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes-file release_notes.md \
            release-files/*.bin
        fi
        
        # Output that release was created/updated
        echo "release_created=true" >> $GITHUB_OUTPUT
    
    - name: Upload artifacts for pages deployment
      if: steps.create_release.outputs.release_created == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: patched-firmware
        path: release-files/
        if-no-files-found: warn
        retention-days: 7
    
    outputs:
      release_created: ${{ steps.create_release.outputs.release_created }}
      release_name: ${{ steps.download.outputs.version }}

  # Deploy to GitHub Pages after release is created
  deploy-pages:
    runs-on: ubuntu-latest
    needs: build-and-release
    if: needs.build-and-release.outputs.release_created == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch latest release data
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch the latest release information
          RELEASE_JSON=$(gh api repos/${{ github.repository }}/releases/latest 2>&1) || {
            echo "::warning::Failed to fetch release data: $RELEASE_JSON"
            RELEASE_JSON='{}'
          }
          
          TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "null" ]; then
            echo "No releases found, creating placeholder page"
            echo "has_release=false" >> $GITHUB_OUTPUT
          else
            echo "has_release=true" >> $GITHUB_OUTPUT
            
            # Extract release information
            RELEASE_NAME=$(echo "$RELEASE_JSON" | jq -r '.name')
            RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body')
            PUBLISHED_AT=$(echo "$RELEASE_JSON" | jq -r '.published_at')
            HTML_URL=$(echo "$RELEASE_JSON" | jq -r '.html_url')
            
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
            echo "html_url=$HTML_URL" >> $GITHUB_OUTPUT
            echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT
            
            # Save release body to file for later use
            printf '%s\n' "$RELEASE_BODY" > /tmp/release_body.md
            
            echo "Release: $RELEASE_NAME ($TAG_NAME)"
          fi

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: patched-firmware
          path: _site/bin

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build site
        env:
          HAS_RELEASE: ${{ steps.release.outputs.has_release }}
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          RELEASE_NAME: ${{ steps.release.outputs.release_name }}
          HTML_URL: ${{ steps.release.outputs.html_url }}
          PUBLISHED_AT: ${{ steps.release.outputs.published_at }}
        run: |
          mkdir -p _site
          
          # Copy CNAME file if exists
          if [ -f CNAME ]; then
            cp CNAME _site/
          fi
          
          # Read HTML template
          cp .github/pages-template.html _site/index.html
          
          # Prepare version info
          if [ "$HAS_RELEASE" = "true" ] && [ -n "$RELEASE_NAME" ]; then
            VERSION_TEXT="v${RELEASE_NAME}"
            VERSION_BADGE="<span class=\"version-badge\">ğŸ“¦ ${VERSION_TEXT}</span>"
          else
            VERSION_TEXT=""
            VERSION_BADGE=""
          fi
          
          # Replace version placeholders
          sed -i "s|{{VERSION}}|${VERSION_TEXT}|g" _site/index.html
          sed -i "s|{{VERSION_BADGE}}|${VERSION_BADGE}|g" _site/index.html
          
          # Generate release content
          if [ "$HAS_RELEASE" = "true" ]; then
            # Format date with fallback
            if [ -n "$PUBLISHED_AT" ]; then
              FORMATTED_DATE=$(date -d "${PUBLISHED_AT}" "+%Y-%m-%d %H:%M UTC" 2>/dev/null || echo "${PUBLISHED_AT%T*}")
            else
              FORMATTED_DATE="æœªçŸ¥"
            fi
            
            # Create release info section (without GitHub Releases link)
            echo '<div class="release-info">' > /tmp/release_content.html
            echo "  <span class=\"version\">ğŸ“¦ æœ€æ–°ç‰ˆæœ¬: ${RELEASE_NAME}</span>" >> /tmp/release_content.html
            echo "  <span class=\"date\"> | å‘å¸ƒæ—¶é—´: ${FORMATTED_DATE}</span>" >> /tmp/release_content.html
            echo '</div>' >> /tmp/release_content.html
            
            # Convert release notes from Markdown to HTML
            if [ -f /tmp/release_body.md ]; then
              # pandoc is pre-installed on ubuntu-latest runner
              if ! command -v pandoc &> /dev/null; then
                echo "Installing pandoc..."
                sudo apt-get update -qq && sudo apt-get install -y -qq pandoc > /dev/null 2>&1
              fi
              
              # Convert GitHub release URLs to relative paths for bin files
              # Pattern: https://github.com/owner/repo/releases/download/tag/filename.bin -> bin/filename.bin
              sed -i 's#https://github.com/[^/]*/[^/]*/releases/download/[^/]*/\([^)]*\.bin\)#bin/\1#g' /tmp/release_body.md
              
              # Convert markdown to HTML and append, with error handling
              pandoc /tmp/release_body.md -f gfm -t html >> /tmp/release_content.html || echo "<p>Failed to render release notes.</p>" >> /tmp/release_content.html
            fi
          else
            # No release yet
            echo '<div class="no-release">' > /tmp/release_content.html
            echo '  <h2>æš‚æ— å‘å¸ƒç‰ˆæœ¬</h2>' >> /tmp/release_content.html
            echo '  <p>ç›®å‰è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•å›ºä»¶ç‰ˆæœ¬ã€‚</p>' >> /tmp/release_content.html
            echo '  <p>è¯·è®¿é—® <a href="https://github.com/NewFuture/jike-led">GitHub ä»“åº“</a> è·å–æ›´å¤šä¿¡æ¯ã€‚</p>' >> /tmp/release_content.html
            echo '</div>' >> /tmp/release_content.html
          fi
          
          # Replace release content placeholder using sed with file
          # Escape special characters (& / \ and the delimiter #)
          RELEASE_CONTENT=$(cat /tmp/release_content.html | sed 's#[&#/\\]#\\&#g' | tr '\n' '\r')
          sed -i "s#{{RELEASE_CONTENT}}#${RELEASE_CONTENT}#g" _site/index.html
          sed -i 's/\r/\n/g' _site/index.html
          
          echo "Site built successfully"
          ls -la _site/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
